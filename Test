public class Game{
 
  //creating a player variable for the player to control, along with a fireball for the player to use
  Dragon player;
  ArrayList<Projectile> fires = new ArrayList<Projectile>();
  ArrayList<Projectile> rocks = new ArrayList<Projectile>();
  ArrayList<Projectile> pillars = new ArrayList<Projectile>();
  
  //creating an array of building variables to hold the data for the buildings, along wrrow for the buildings to fire 
  ArrayList<Building> building = new ArrayList<Building>();
  ArrayList<Projectile> arrows = new ArrayList<Projectile>();
  ArrayList<TownUnit> units = new ArrayList<TownUnit>();
  //creating a screen variable to draw everything with and a vaariable for the dimensions of the field
  Screen screen;
  int fieldHieght, fieldWidth, floor;
  
  public Game(){
    //setting the screen size and setting the field dimensions
    fieldWidth = (int)(width * 2);
    fieldHieght = (int)(height * 1.5);
    floor = fieldHieght - 200;
    
    //declaring the player variable
    player = new Dragon(width/2, height/2, 40);
    
    //declaring and creating 4 buildings
    int x = (int)random(0,80);
    while(x < fieldWidth - 100){
      int newBuilding = (int)random(3);
      if (newBuilding == 0){
        building.add(new ArcherTower(x + 100, fieldHieght - fieldHieght/25 - 50, 200, 100));
        x += 200;
      }
      else if (newBuilding == 1){
        building.add(new WizardTower(x + 50, fieldHieght - fieldHieght/25 - 50, 100, 100));
        x += 100;
      }
      else if (newBuilding == 2){
        building.add(new Barracks(x + 100, fieldHieght - fieldHieght/25 - 50, 200, 100));
        x += 200;
      }
      x +=(int)random(20,80);
    }
    
    fieldWidth = fieldWidth - (fieldWidth - x) + (int)random(0,80);
    //creating the screen class
    screen = new Screen(0, 0, width, height, fieldWidth, fieldHieght);
  }
  
  public Game(ArrayList<Building> buildings, int fieldWidth, int fieldHeight){
    //setting the screen size and setting the field dimensions
    this.fieldWidth = fieldWidth;
    this.fieldHieght = fieldHeight;
    floor = fieldHieght - 200;
    
    //declaring the player variable
    player = new Dragon(width/2, height/2, 40);
    
    this.building = new ArrayList<Building>(buildings);
    
    //creating the screen class
    screen = new Screen(0, 0, width, height, fieldWidth, fieldHieght);
  }
  
  public int update(){
    clear();
    int command = updateGame();
    collisions();
    return command;
  }
  
  private int updateGame(){
    int command = -1;
    player.update(keys, floor);  //updating the player
    if (player.isRemoved())  //checking if the player is removed and setting the return command to 0 if true
      command = 0;
    
    //updating all the buildings
    for (int i = 0; i < building.size(); i++){
      building.get(i).update(player);
      
      if (building.get(i).Attack()){  //checking if the building attacked and getting a new arrow from the building if true
        if (building.get(i).makeProjectile())
          arrows.add(building.get(i).newArrow(player));
        else 
          units.add(building.get(i).newUnit()); }
      
      
      //removing the building if it's remove variable is true
      if (building.get(i).isRemoved()){
        building.remove(i);
        i--;
      }
    }
    
    
    
    if (player.Attack())  //checking whether to make a new fireball attack
      fires.add(player.newAttack(screen.screenX, screen.screenY, screen.scale, 0));
    if (player.Attack2())
      rocks.add(player.newAttack(screen.screenX, screen.screenY, screen.scale, 1));
      
      
    //updating all the dragons attacks
    for (int i = 0; i < fires.size(); i++){
      fires.get(i).update();  
      
      //removing the attack if it's remove variable is true
      if (fires.get(i).isRemoved()){
        fires.remove(i);
        i--;
      }
    }
    
    for (int i = 0; i < rocks.size(); i++){
      rocks.get(i).update();  
      
      //removing the attack if it's remove variable is true
      if (rocks.get(i).isRemoved()){
        rocks.remove(i);
        i--;
      }
    }
    
    for (int i = 0; i < pillars.size(); i++){
      pillars.get(i).update();  
      
      //removing the attack if it's remove variable is true
      if (pillars.get(i).isRemoved()){
        pillars.remove(i);
        i--;
      }
    }
    
    //updating all the building attacks
    for (int i = 0; i < arrows.size(); i++){
      arrows.get(i).update(); 
      
      //removing the attack if it's remove variable is true
      if (arrows.get(i).isRemoved()){    
        if(arrows.get(i).type == 2){
          for(int j=0; j<8; j++){
            arrows.add(new WizardFireSplit(arrows.get(i).getX(), arrows.get(i).getY(), arrows.get(i).getWidth(), arrows.get(i).getHeight(), radians(j*45)));
          }    
        }
        arrows.remove(i);
        i--;
        
      }
    }
    
    //updating all the towns units
    for (int i = 0; i < units.size(); i++){
      units.get(i).update(player); 
      
      //removing the unit if it's remove variable is true
      if (units.get(i).isRemoved()){
        units.remove(i);
        i--;
      }
    }
    
    return command;  //returning any commands the game needs done
  }
  
  private void collisions(){
    //checking all the dragon's attacks and building for collisions and running their code for when hit if any collisions are found
    for (int i = 0; i < fires.size(); i++){
      for (int j = 0; j < building.size(); j++){
        if (fires.get(i).collide(building.get(j))){
          building.get(j).hit(fires.get(i));
          fires.get(i).hit();
        }
      }
    }
    
    for (int i = 0; i < fires.size(); i++){
      for (int j = 0; j < units.size(); j++){
        if (fires.get(i).collide(building.get(j))){
          building.get(j).hit(fires.get(i));
          fires.get(i).hit();
        }
      }
    }
    
    for (int i = 0; i < rocks.size(); i++){
     if (rocks.get(i).y > fieldHieght - fieldHieght/25){       
      pillars.add(new DragonPillar(rocks.get(i).x, fieldHieght - fieldHieght/25 + 25, 50, 50));
      rocks.get(i).hit();
     }
    }
    
    for (int i = 0; i < pillars.size(); i++){
      for (int j = 0; j < building.size(); j++){
        if (pillars.get(i).collide(building.get(j))){
          building.get(j).hit(pillars.get(i));
          pillars.get(i).hit();
        }
      }
    }
      
    for (int i = 0; i < pillars.size(); i++){
      for (int j = 0; j < units.size(); j++){
        if (pillars.get(i).collide(units.get(j))){
          units.get(j).hit(pillars.get(i));
          pillars.get(i).hit();
        }
      }
    }
      
      //for (int j = 0; j < units.size(); j++){
      //  if (pillars.get(i).collide(units.get(j))){
      //    units.get(j).hit(pillars.get(i));
      //    pillars.get(i).hit();
      //  }
      //}
    //}
//    
   //for (int i = 0; i < rocks.size(); i++){
   //   for (int j = 0; j < building.size(); j++){
   //     if (rocks.get(i).collide(building.get(j))){
   //       building.get(j).hit(rocks.get(i));
   //       rocks.get(i).hit();
   //     }
   //   }
   // }
    
    //checking all the town's attacks and player for collisions and running their code for when hit if any collisions are found
    for (int i = 0; i < arrows.size(); i++){
      if (arrows.get(i).collide(player)){
        player.hit(arrows.get(i));
        arrows.get(i).hit();
      }
    }
  }
  
  public void render(){
    pushMatrix();
    screen.update(player);  //updating the screen to display the correct amount of the screen
    
    background(0,100,220);  //making the background colour sky blue and drawing the ground
    
    //drawing all the buildings
    for (int i = 0; i < building.size(); i++)
      building.get(i).render(screen);
    
    for (int i = 0; i < pillars.size(); i++)
      pillars.get(i).render(screen);
      
    noStroke();
    //making the background colour sky blue and drawing the ground
    screen.render(1, color(0,200,0), fieldWidth/2, fieldHieght - fieldHieght/50, fieldWidth+5, fieldHieght/25, 0);
      
    player.render(screen);  //drawing the player
    
    //drawing all the dragon's attacks
    for (int i = 0; i < fires.size(); i++)
      fires.get(i).render(screen);
    for (int i = 0; i < rocks.size(); i++)
      rocks.get(i).render(screen);
      
    //drawing all the town's attacks
    for (int i = 0; i < arrows.size(); i++)
      arrows.get(i).render(screen);
    
    //drawing all the town's units
    for (int i = 0; i < units.size(); i++)
      units.get(i).render(screen);
      
    for (int i = 0; i < building.size(); i++)
      building.get(i).renderHUD(screen);
      
    popMatrix();  //reseting the matrix to before it was all rescaled and translated
    
    player.renderHUD(screen);  //drawing the players HUD
  }
}
